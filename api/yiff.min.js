// @ts-nocheck
export default async function handler(t,e){const{postId:n,embed:r=!1}=t.query;if(!n)return e.status(400).json({error:"Post ID not specified!"});const o=t.headers.host||"",a=o.includes("e926")?"e926.net":"e621.net";try{const t=await fetch(d,{headers:{"User-Agent":"MyE621Proxy/1.0 (by yourusername on e621)"}});if(!t.ok)return e.status(t.status).json({error:"Failed to fetch post data"});const s=await t.json(),i=s?.post;if(!i||!i.file?.url)return e.status(404).json({error:"Image URL not found in post data"});const m=await fetch(i.file.url,{headers:{"User-Agent":"MyE621Proxy/1.0 (by yourusername on e621)"}}),c=i.file.ext,p=i.preview?.url,d=`https://${o}/api?postId=${n}`,y=["webm","mp4"].includes(c),l=`Post #${n} from ${a}`;if("true"===r){const t=`\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <meta charset="UTF-8">\n          <meta name="viewport" content="width=device-width, initial-scale=1.0">\n\n          \x3c!-- Open Graph --\x3e\n          <meta property="og:title" content="${l}" />\n          <meta property="og:type" content="${y?"video.other":"image"}" />\n          <meta property="og:image" content="${p}" />\n          ${y?`\n            <meta property="og:video" content="${d}" />\n            <meta property="og:video:type" content="video/${c}" />\n            <meta property="og:video:width" content="1280" />\n            <meta property="og:video:height" content="720" />\n          `:""}\n\n          \x3c!-- Twitter --\x3e\n          <meta name="twitter:card" content="${y?"player":"summary_large_image"}" />\n          <meta name="twitter:title" content="${l}" />\n          <meta name="twitter:image" content="${p}" />\n          ${y?`\n            <meta name="twitter:player" content="${d}" />\n            <meta name="twitter:player:width" content="1280" />\n            <meta name="twitter:player:height" content="720" />\n            <meta name="twitter:player:stream" content="${d}" />\n            <meta name="twitter:player:stream:content_type" content="video/${c}" />\n          `:""}\n        </head>\n        <body>\n          <p>Embed preview for post #${n} from ${a}</p>\n        </body>\n        </html>\n      `.trim();return e.setHeader("Content-Type","text/html"),e.status(200).send(t)}if(!m.ok)return e.status(m.status).json({error:"Failed to fetch image"});const u=await m.arrayBuffer(),h=Buffer.from(u),f=m.headers.get("content-type")||"image/jpeg";return e.setHeader("Content-Type",f),e.setHeader("Access-Control-Allow-Origin","*"),e.status(200).send(h)}catch(t){return console.error("Error:",t),e.status(500).json({error:"Failed to fetch from E621",details:t.message})}}