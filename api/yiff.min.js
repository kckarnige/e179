// @ts-nocheck
export default async function handler(e,t){const{slug:n,embed:s=!1,format:a=null}=e.query,r=e.headers.accept||"";if(!n)return t.status(400).json({error:"Invalid or missing post ID and extension"});const[o,i]=n.split(".");if(!/^\d+$/.test(o))return t.status(400).json({error:"Invalid post ID"});const d=`https://e621.net/posts/${o}.json`,c=e.headers.host||"";var u;u="e.e694.net"==c||"e621.e694.net"==c||"e621.kckarnige.online"==c||"e621-media.vercel.app"==c?"e621.net":"e926.net";try{const e=await fetch(d,{headers:{"User-Agent":"e694/1.2"}});if(!e.ok)return t.status(e.status).json({error:"Failed to fetch post data"});const n=await e.json(),h=n?.post,g=i??h.file.ext,m=new Date(h.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});if("json"===i)return t.status(200).json(n);if(!h||!h.file?.url)return t.status(404).json({error:"Media URL not found in post data"});const j=await fetch(h.file.url,{headers:{"User-Agent":"e694/1.2"}});if("json"===a||r.includes("application/json+oembed")){const e=`https://${c}/posts/${o}`;return t.status(200).json({type:"rich",url:e,description:"Random fun fact\\: Minecraft Bedrock has a feature where you can set a screenshot as your ingame profile banner\\. You can edit your existing screenshots or add your own from scratch as long as it's in jpeg format and has a valid json file to match with it\\.\n\nThe result\\:",color:"00709e",timestamp:m,author:{name:"KiCKTheBucket (@kckarnige.online)",url:e,icon_url:"https://cdn.bsky.app/img/avatar/plain/did:plc:2hkkpfrodwapb4whfvqtbf4b/bafkreigst6n4wnjd75mjexzdvn6oaub3wivsswrvcgnysllxdqefqkatzi@jpeg"},image:{url:"https://cdn.bsky.app/img/feed_fullsize/plain/did:plc:2hkkpfrodwapb4whfvqtbf4b/bafkreidej5leu73pstuq7z46yom36syjy3jkt4j7bjtoabh3ih3kxutnjm@jpeg",width:615,height:548,content_type:j.headers.get("content-type"),flags:0},footer:{text:"e694",icon_url:"https://e694.net/favicon.png"}})}if("true"===s){h.preview,"e926.net"==u&&h.rating,["webm","mp4"].includes(g);var l=h.tags.artist.concat(h.tags.contributor??[]),p=["sound_warning","third-party_edit","conditional_dnp"],f=l.filter((e=>!p.includes(e)));(h.tags.artist.includes("sound_warning")||h.tags.meta.includes("sound")&&!h.tags.meta.includes("no_sound"))&&"\n\nðŸ”Š Sound Warning! ðŸ”Š",1===f.length?`${f[0]}`:`${f[0]} +${f.length-1}`;const e=`\n          <link type="application/json+oembed" href="https://${c}/posts/${o}?format=json" title="e694 Embed" />\n      `.trim();return t.setHeader("Content-Type","text/html"),t.status(200).send(e)}if(!j.ok)return t.status(j.status).json({error:"Failed to fetch image"});const y=await j.arrayBuffer(),w=Buffer.from(y),b=j.headers.get("content-type")||"image/jpeg";return t.setHeader("Content-Disposition",`inline; filename="${o}.${g}"`),t.setHeader("Content-Type",b),t.setHeader("Access-Control-Allow-Origin","*"),t.status(200).send(w)}catch(e){return console.error("Error:",e),t.status(500).json({error:"Failed to fetch from API",details:e.message})}}