// @ts-nocheck
export default async function handler(t,e){const{slug:n,embed:r=!1}=t.query;if(!n)return e.status(400).json({error:"Invalid or missing post ID and extension"});const[o,a]=n.split(".");if(!/^\d+$/.test(o))return e.status(400).json({error:"Invalid post ID"});const s=t.headers.host||"",i=s.includes("e926")?"e926.net":"e621.net",c=`https://e621.net/posts/${o}.json`;function l(t=""){return String(t).replace(/[&<>"']/g,(t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[t])))}try{const t=await fetch(c,{headers:{"User-Agent":"e179/1.0"}});if(!t.ok)return e.status(t.status).json({error:"Failed to fetch post data"});const n=await t.json(),p=n?.post,d=a??p?.file?.ext;if("json"===a)return e.status(200).json(n);if(!p||!p.file?.url)return e.status(404).json({error:"Media URL not found in post data"});const m=p.file.url,u=p.preview?.url||"",h=(["webm","mp4"].includes(d),(p.tags.artist??[]).concat(p.tags.contributor??[])),g=["sound_warning","third-party_edit","conditional_dnp"],f=h.filter((t=>!g.includes(t)));let y="";!p.tags.artist.includes("sound_warning")&&!p.tags.meta.includes("sound")||p.tags.meta.includes("no_sound")||(y='<meta property="og:description" content="ðŸ”Š Sound Warning! ðŸ”Š" />');f.length&&(l(f[0]),f.length>1&&f.length),l(u);const w=l(m);l(s),l(o),l(i);if("true"===r){const t=`\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8" />\n  <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n\n  \x3c!-- Theme & Icons --\x3e\n  <meta name="theme-color" content="#00709e" />\n  <link rel="icon" href="/favicon.ico" />\n  <link rel="apple-touch-icon" href="/favicon.png" />\n\n  \x3c!-- Article Metadata --\x3e\n  <meta property="og:type" content="article" />\n  <meta property="og:title" content="#123456 by artist_name" />\n  <meta property="og:description" content="Posted on June 7, 2025 â€¢ Score: 243 â€¢ Rating: SFW" />\n  <meta property="og:image" content="${w}" />\n  <meta property="og:url" content="${w}" />\n  <meta property="article:published_time" content="2025-06-07T12:00:00Z" />\n  <meta property="article:author" content="artist_name" />\n  <meta property="og:site_name" content="Image from e621.net â€¢ e179" />\n\n  \x3c!-- Twitter Metadata --\x3e\n  <meta name="twitter:card" content="summary_large_image" />\n  <meta name="twitter:title" content="#123456 by artist_name" />\n  <meta name="twitter:description" content="Posted on June 7, 2025 â€¢ Score: 243 â€¢ Rating: SFW" />\n  <meta name="twitter:image" content="${w}" />\n\n  <title>#123456 by artist_name</title>\n</head>\n<body>\n  <article>\n    <h1>#123456 by artist_name</h1>\n    <p>This is a custom embed page with additional information about the post.</p>\n    <p>Posted: June 7, 2025</p>\n    <p>Rating: SFW</p>\n    <p>Score: 243</p>\n    <footer>From <a href="https://e621.net/posts/123456">e621.net</a> â€¢ Proxy by e179</footer>\n  </article>\n\n  \x3c!-- Optional auto-redirect --\x3e\n  <script>\n    window.location.href = "https://e621.net/posts/123456";\n  <\/script>\n</body>\n</html>\n\n      `.trim();return e.setHeader("Content-Type","text/html"),e.status(200).send(t)}const x=await fetch(m,{headers:{"User-Agent":"e179/1.0 (e621 Proxy)"}});if(!x.ok)return e.status(x.status).json({error:"Failed to fetch media file"});const b=await x.arrayBuffer(),_=Buffer.from(b),j=x.headers.get("content-type")||"image/jpeg";return e.setHeader("Content-Disposition",`inline; filename="${o}.${d}"`),e.setHeader("Cache-Control","public, max-age=86400"),e.setHeader("Content-Type",j),e.setHeader("Access-Control-Allow-Origin","*"),e.status(200).send(_)}catch(t){return console.error("Error:",t),e.status(500).json({error:"Failed to fetch from API",details:t.message})}}