// @ts-nocheck
export default async function handler(e,t){const{slug:n,embed:o=!1}=e.query;if(!n)return t.status(400).json({error:"Invalid or missing post ID and extension"});const[a,r]=n.split("."),s=`https://e621.net/posts/${a}.json`,i=e.headers.host||"";var c;c="e694.net"==i||"e.e694.net"==i||"e621.e694.net"==i||"e621.kckarnige.online"==i||"e621-media.vercel.app"==i?"e621.net":"e926.net";try{const n=await fetch(s,{headers:{"User-Agent":"e694/1.4"}});if(!n.ok)return t.status(n.status).json({error:"Failed to fetch post data"});const u=await n.json(),g=u?.post,h=r??g.file.ext,f=(g.preview,`https://${i}/${a}.${h}`);"e926.net"==c&&"s"!==g.rating||["webm","mp4"].includes(h);var p="",l=g.tags.artist.concat(g.tags.contributor??[]),d=["sound_warning","third-party_edit","conditional_dnp"],m=l.filter((e=>!d.includes(e)));(g.tags.artist.includes("sound_warning")||g.tags.meta.includes("sound")&&!g.tags.meta.includes("no_sound"))&&(p="\nðŸ”Š Sound Warning! ðŸ”Š");const y=new Date(g.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),$={s:"Safe",q:"Questionable",e:"Explicit"};if("json"===r)return t.status(200).json(u);if(!g||!g.file?.url)return t.status(404).json({error:"Media URL not found in post data"});const w=e.headers.accept||"";if("json+oembed"===r||w.includes("application/json+oembed"))return t.setHeader("Content-Type","application/json+oembed"),t.status(200).json({author_name:`Posted on ${y}\nRating: ${$[g.rating]} â€Ž â€¢ â€Ž Score: ${g.score.total}${p}`});if("true"===o){const e=`\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <meta charset="UTF-8">\n          <meta name="viewport" content="width=device-width, initial-scale=1.0">\n          <meta property="theme-color" content="#00709e" />\n          <link rel="icon" href="/favicon.ico" />\n          <meta name="application-name" content="e694">\n          <link rel="alternate" type="application/json+oembed" href="https://${i}/${a}.json+oembed">\n          <link rel="apple-touch-icon" href="https://e694.net/icon.png" />\n          <link rel="icon" type="image/png" href="https://e694.net/icon.png">\n          <link rel="icon" type="image/png" sizes="32x32" href="https://e694.net/favicon32.png">\n          <link rel="icon" type="image/png" sizes="16x16" href="https://e694.net/favicon16.png">\n          <meta property="title" content="#${a}" />\n\n          \x3c!-- Open Graph --\x3e\n          <meta property="og:title" content="#${a} by ${1===m.length?`${m[0]}`:`${m[0]} +${m.length-1}`}" />\n          <meta property="og:type" content="image" />\n          \n            <meta property="og:image" content="${f}" />\n            <meta property="og:site_name" content="Image from ${c} â€¢ e694">\n          \n\n          \x3c!-- Twitter --\x3e\n          <meta property="twitter:card" content="summary_large_image" />\n          <meta property="twitter:title" content="Post from ${c}" />\n          \n            <meta property="twitter:image" content="${f}" />\n          \n          <style>html,body{background:#012e57;}</style>\n        </head>\n        <body>\n            <script>window.location = "https://${c}/posts/${a}"<\/script>\n        </body>\n        </html>\n      `.trim();return t.setHeader("Content-Type","text/html"),t.status(200).send(e)}const j=await fetch("e926.net"==c&&"s"!==g.rating?"https://e694.net/unsafe.png":g.file.url,{headers:{"User-Agent":"e694/1.4"}});if(!j.ok)return t.status(j.status).json({error:"Failed to fetch image"});const b=await j.arrayBuffer(),x=Buffer.from(b),k=j.headers.get("content-type")||"image/jpeg";return t.setHeader("Cache-Control","public, max-age=300, stale-while-revalidate=60"),t.setHeader("Content-Disposition",`inline; filename="${a}.${h}"`),t.setHeader("Content-Type",k),t.setHeader("Access-Control-Allow-Origin","*"),t.status(200).send(x)}catch(e){return console.error("Error:",e),t.status(500).json({error:"Failed to fetch from API",details:e.message})}}