// @ts-nocheck
export default async function handler(t,e){const{slug:n,embed:o=!1,format:r=null}=t.query,a=t.headers.accept||"";if(!n)return e.status(400).json({error:"Invalid or missing post ID and extension"});const[i,s]=n.split(".");if(!/^\d+$/.test(i))return e.status(400).json({error:"Invalid post ID"});const p=`https://e621.net/posts/${i}.json`,c=t.headers.host||"";var l;l="e.e694.net"==c||"e621.e694.net"==c||"e621.kckarnige.online"==c||"e621-media.vercel.app"==c?"e621.net":"e926.net";try{const t=await fetch(p,{headers:{"User-Agent":"e694/1.2"}});if(!t.ok)return e.status(t.status).json({error:"Failed to fetch post data"});const n=await t.json(),u=n?.post,f=s??u.file.ext,y=new Date(u.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),$={s:"Safe",q:"Questionable",e:"Explicit"};if("json"===s)return e.status(200).json(n);if(!u||!u.file?.url)return e.status(404).json({error:"Media URL not found in post data"});const w=await fetch(u.file.url,{headers:{"User-Agent":"e694/1.2"}});if("json"===r||a.includes("application/json+oembed")){const t=`https://${c}/posts/${i}`;return e.status(200).json({type:"rich",url:t,description:"Random fun fact\\: Minecraft Bedrock has a feature where you can set a screenshot as your ingame profile banner\\. You can edit your existing screenshots or add your own from scratch as long as it's in jpeg format and has a valid json file to match with it\\.\n\nThe result\\:",color:"00709e",timestamp:y,author:{name:"KiCKTheBucket (@kckarnige.online)",url:t,icon_url:"https://cdn.bsky.app/img/avatar/plain/did:plc:2hkkpfrodwapb4whfvqtbf4b/bafkreigst6n4wnjd75mjexzdvn6oaub3wivsswrvcgnysllxdqefqkatzi@jpeg"},image:{url:"https://cdn.bsky.app/img/feed_fullsize/plain/did:plc:2hkkpfrodwapb4whfvqtbf4b/bafkreidej5leu73pstuq7z46yom36syjy3jkt4j7bjtoabh3ih3kxutnjm@jpeg",width:615,height:548,content_type:w.headers.get("content-type"),flags:0},footer:{text:"e694",icon_url:"https://e694.net/favicon.png"}})}if("true"===o){const t=u.preview?.url,n="e926.net"==l&&"s"!==u.rating?"https://e694.net/unsafe.png":`https://${c}/${i}.${f}`,o=["webm","mp4"].includes(f);var d="",m=u.tags.artist.concat(u.tags.contributor??[]),h=["sound_warning","third-party_edit","conditional_dnp"],g=m.filter((t=>!h.includes(t)));(u.tags.artist.includes("sound_warning")||u.tags.meta.includes("sound")&&!u.tags.meta.includes("no_sound"))&&(d="\n\nðŸ”Š Sound Warning! ðŸ”Š");const r=`\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <meta charset="UTF-8">\n          <meta name="viewport" content="width=device-width, initial-scale=1.0">\n          <meta property="theme-color" content="#00709e" />\n          <link rel="icon" href="/favicon.ico" />\n          <meta name="application-name" content="e694">\n          <meta name="generator" content="e694">\n          <link rel="apple-touch-icon" href="https://e694.net/favicon.png" />\n          <link type="application/json+oembed" href="https://${c}/posts/${i}?format=json" title="e694 Embed" />\n          <link rel="icon" type="image/png" sizes="32x32" href="https://e694.net/favicon32.png">\n          <link rel="icon" type="image/png" sizes="16x16" href="https://e694.net/favicon16.png">\n          <meta property="title" content="#${i}" />\n\n          \x3c!-- Open Graph --\x3e\n          <meta property="og:title" content="#${i} by ${1===g.length?`${g[0]}`:`${g[0]} +${g.length-1}`}" />\n          <meta property="og:description" content="Posted on ${y}\nRating: ${$[u.rating]}\nScore: ${u.score.total}${d}" />\n          <meta property="og:type" content="${o?"video.other":"image"}" />\n          ${o?`\n            <meta property="og:video" content="${n}" />\n            <meta property="og:video:type" content="video/${f}" />\n            <meta property="og:video:width" content="1280" />\n            <meta property="og:video:height" content="720" />\n            <meta property="og:image" content="${t}" />\n            <meta property="og:site_name" content="Video from ${l} â€¢ e694">\n          `:`\n            <meta property="og:image" content="${n}" />\n            <meta property="og:site_name" content="Image from ${l} â€¢ e694">\n          `}\n\n          \x3c!-- Twitter --\x3e\n          <meta property="twitter:card" content="${o?"player":"summary_large_image"}" />\n          <meta property="twitter:title" content="Post from ${l}" />\n          <meta property="twitter:description" content="Posted on ${y}\nRating: ${$[u.rating]}\nScore: ${u.score.total}${d}" />\n          ${o?`\n            <meta property="twitter:image" content="${t}" />\n            <meta property="twitter:player" content="${n}" />\n            <meta property="twitter:player:width" content="1280" />\n            <meta property="twitter:player:height" content="720" />\n            <meta property="twitter:player:stream" content="${n}" />\n            <meta property="twitter:player:stream:content_type" content="video/${f}" />\n          `:`\n            <meta property="twitter:image" content="${n}" />\n          `}\n        </head>\n        <body>\n            <script>window.location = "https://${l}/posts/${i}"<\/script>\n        </body>\n        </html>\n      `.trim();return e.setHeader("Content-Type","text/html"),e.status(200).send(r)}if(!w.ok)return e.status(w.status).json({error:"Failed to fetch image"});const j=await w.arrayBuffer(),v=Buffer.from(j),b=w.headers.get("content-type")||"image/jpeg";return e.setHeader("Content-Disposition",`inline; filename="${i}.${f}"`),e.setHeader("Content-Type",b),e.setHeader("Access-Control-Allow-Origin","*"),e.status(200).send(v)}catch(t){return console.error("Error:",t),e.status(500).json({error:"Failed to fetch from API",details:t.message})}}